<!DOCTYPE html>
<!--[if IE 6]>
<html id="ie6" lang="zh-CN">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="zh-CN">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="zh-CN">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="en-US" class="js">
<!--<![endif]-->
  

	

	
<head>
	<meta charset="utf-8">
	<title>The Diagonality of Barcelona | Online Profile</title>
	<meta name="description" content=", Data Munging, Data data-analysis, Barcelona, Python, numpy, matplotlib, Data Munging and Analyzing Barcelona OSM Data">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-Frame-Options" content="sameorigin">
	<!-- CSS -->
	<link rel="stylesheet" href="/css/main.css">
	<link rel='stylesheet' id='divi-style-css'  href="/css/style.css" type='text/css' media='all' />
	<link rel="stylesheet" href="/css/post.style.css">

	<script type='text/javascript' src="/js/jquery.js"></script>
	<script type='text/javascript' src="/js/soundmanager2-nodebug-jsmin.js"></script>

	<!--Favicon-->
	<link rel="icon" href="favicon.ico" type="image/x-icon"/>
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	
	<link href="/favicon.ico" mce_href="favicon.ico" rel="bookmark" type="image/x-icon" /> 
	<link href="/favicon.ico" mce_href="favicon.ico" rel="icon" type="image/x-icon" /> 
	<link href="/favicon.ico" mce_href="favicon.ico" rel="shortcut icon" type="image/x-icon" /> 
	<!-- Canonical -->
	<link rel="canonical" href="http://cole-maclean.github.io//blog/new-test-post/">

	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="Online Profile" href="http://cole-maclean.github.io//feed.xml" />

	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
	

	<!-- KaTeX -->
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.js"></script>
	

	<!-- Google Analytics -->
	
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-71787228-1', 'auto');
	ga('send', 'pageview');
	</script>
	

	<script type="text/javascript">
    var host = "http://cole-maclean.github.io/";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
    </script>
     <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71787228-1', 'auto');
ga('send', 'pageview');

</script>
 
</head>

	<body class="home blog et_pb_button_helper_class home-posts et_fixed_nav et_show_nav et_cover_background et_pb_gutter windows et_pb_gutters3 et_primary_nav_dropdown_animation_fade et_secondary_nav_dropdown_animation_fade et_pb_footer_columns4 et_header_style_left et_right_sidebar chrome">
		<div id="page-container">
    		<header id="main-header" data-height-onload="66">
	<div class="container clearfix et_menu_container">
		<div class="logo_container">
			<span class="logo_helper"></span>
			<a href="/">
				<!--img src="http://blog.ibireme.com/wp-content/uploads/2015/05/logo1.png" alt="Garan no dou" id="logo" data-height-percentage="54" /-->
				Online Profile - Cole MacLean
			</a>
		</div>
		<div id="et-top-navigation" data-height="66" data-fixed-height="40">
			<nav id="top-menu-nav">
				<ul id="top-menu" class="nav">
					<li>
						<a class="page-link" href="/">
							Home
						</a>
					</li>
					
					
					<li>
						<a class="page-link" href="/projects/">
							Projects
						</a>
					</li>
					
					
					
					<li>
						<a class="page-link" href="/About/">
							About
						</a>
					</li>
					
					
					
					<li>
						<a class="page-link" href="/Archives/">
							Archive
						</a>
					</li>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					<!-- Social icons from Font Awesome, if enabled -->
					<li>
						<a class="page-link" href="">Find Me</a>
						<ul class="children">












<li>
	<a href="https://github.com/cole-maclean" title="Follow on GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>









<li>
	<a href="https://www.linkedin.com/in/macleancole" title="Follow on LinkedIn">
		<i class="fa fa-fw fa-linkedin"></i>
	</a>
</li>















<li>
	<a href="https://twitter.com/ponderingHplus" title="Follow on Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>







<li>
	<a href="https://www.kaggle.com/colemaclean" title="">
		<i>kaggle</i>
	</a>
</li>



<li>
	<a href="mailto:maclean.cole@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>

</ul>
					</li>
					
				</ul>
			</nav>

			<div id="et_mobile_nav_menu">
				<div class="mobile_nav closed">
					<span class="select_page"></span>
					<span class="mobile_menu_bar"></span>
				</div>
			</div>				
		</div> <!-- #et-top-navigation -->
	</div> <!-- .container -->
	<div class="et_search_outer">
		<div class="container et_search_form_container">
			<form role="search" method="get" class="et-search-form" action="http://cole-maclean.github.io/">
			<input type="search" class="et-search-field" placeholder="搜索 &hellip;" value="" name="s" title="搜索：" /></form>
			<span class="et_close_search_field"></span>
		</div>
	</div>
</header> <!-- #main-header -->

    		<div id="et-main-area">
      			

	

	

<article >
  <header style="background-image: url('/')">

<!--article  >
  <div style="background-image: url('/')"/>
  <header style="background-image: url('')"-->
    <h1 class="title">The Diagonality of Barcelona</h1>
    <p id="subtitletrans" class="subtitlecontainer">
    <a class="subtitle">2015-12-28</a> | <a class = "subtittle" href=>HN</a>
	 <a class="subtitle"></a> <a class="subtitle">  <i class="fa fa-tags"></i>: <a href="/tags/data-munging/">Data Munging</a>, <a href="/tags/data-analysis/">Data data-analysis</a>, <a href="/tags/barcelona/">Barcelona</a>, <a href="/tags/python/">Python</a>, <a href="/tags/numpy/">numpy</a>, <a href="/tags/matplotlib/">matplotlib</a></a>
    </p>
  </header>
  <section class="post-content">
  <h1>Data Munging and Analyzing Barcelona OSM Data</h1>

<p>The XML data for the city boundary of Barcelona was downloaded from OSM to clean and transform into a json encodable structure to allow loading into MongoDB, providing storage and artbitrary querying to enable further data analysis of the Barcelona OSM dataset. I chose the Barcelona dataset because I just recently spent a few weeks there and noticed some pretty cool urban planning features of the city (ie. Avinguda Diagonal) that could be cool to explore further.</p>

<p>Inspired by the “Diagonality” of Barcelona streets and to give the scope of the project a little more focus, I will be attempting to analyze the Barcelona OSM data and see if I can generate a measure for the “degree of diagionality” for Barcelona and possibly compare this measure with other cities. Not knowing ahead of time the difficulty of this, I may eventually have to delete this previous sentence, but I’m interested enough to give it a shot.</p>

<p><img src="http://static1.squarespace.com/static/52b3aae6e4b00492bb71aa3d/t/54776cbde4b019f8929d0684/1414769949925/?format=1500w" /></p>

<p>From <a href="http://www.dailyoverview.com/six/">dailyoverview.com</a></p>

<h2>Imports and Data prep</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">heapq</span>

<span class="n">OSM_FILE</span> <span class="o">=</span> <span class="s">"C:/Users/Cole/Desktop/Udacity/Data Analyst Nano Degree/Project 3/barcelona_spain.osm"</span>  <span class="c"># Replace this with your osm file</span>
<span class="n">SAMPLE_FILE</span> <span class="o">=</span> <span class="s">"C:/Users/Cole/Desktop/Udacity/Data Analyst Nano Degree/Project 3/barcelona_spain_sample.osm"</span>
<span class="k">def</span> <span class="nf">get_element</span><span class="p">(</span><span class="n">osm_file</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">(</span><span class="s">'node'</span><span class="p">,</span> <span class="s">'way'</span><span class="p">,</span> <span class="s">'relation'</span><span class="p">)):</span>
    <span class="s">"""Yield element if it is the right type of tag

    Reference:
    http://stackoverflow.com/questions/3095434/inserting-newlines-in-xml-file-generated-via-xml-etree-elementtree-in-python
    """</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">osm_file</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s">'start'</span><span class="p">,</span> <span class="s">'end'</span><span class="p">))</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">root</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s">'end'</span> <span class="ow">and</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">elem</span>
            <span class="n">root</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SAMPLE_FILE</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'&lt;osm&gt;</span><span class="se">\n</span><span class="s">  '</span><span class="p">)</span>

    <span class="c"># Write every 100th top level element</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">get_element</span><span class="p">(</span><span class="n">OSM_FILE</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">))</span>

    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'&lt;/osm&gt;'</span><span class="p">)</span>


</code></pre>
</div>

<p><b>Visual Data Inspection</b></p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#This code attempts to pick out unique data structures from the SAMPLE_FILE to give us examples of </span>
<span class="n">unique_elements</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">get_element</span><span class="p">(</span><span class="n">SAMPLE_FILE</span><span class="p">)):</span>
    <span class="n">elem_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="nb">iter</span><span class="p">():</span>
        <span class="n">elem_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">elem_children</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_elements</span><span class="p">:</span>
        <span class="n">unique_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem_children</span><span class="p">)</span>
        <span class="c">#print ET.tostring(element, encoding='utf-8')</span>
<span class="k">print</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_elements</span><span class="p">))</span>
</code></pre>
</div>

<p>Reviewing the unique elements above yields a few considerations for potential data issues and facts pertinent to the goal of reporting a “degree of diagionality”:<br />
1. Being a Spanish City, the non-standard characters common in Spanish names might exist that could cause potential problems 
2. The amount of data for a given node or way varies. The minimum required data to enable calculation of a streets angle will need to be defined.
3. Nodes contain the required lat/lon coordinates required for calculating a ways angle<br />
4. Ways list the nodes that create the path of a street. This path may not be a straight line, which may have an impact on the angle calculation<br />
5. Not all ways have a street attribute, but still seem valid, such as examples that have a “highway” attribute</p>

<p><b>Data Shaping</b><br />
In order to perform a calculation of “diagonality” of a way, we need at least 2 nodes on the way that have lat/lon data. To ensure the way is a valid road to calculate diagionality on, the way must have one of: a valid steet or highway attribute. We will only keep top level data such as id, lat/lon and created data for nodes. To load this data into MongoDB for storage and querying, we need to shape this data into valid JSON, which the below code does.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Utility Regular Expressions</span>
<span class="n">lower</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">r'^([a-z]|_)*$'</span><span class="p">)</span>
<span class="n">lower_colon</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">r'^([a-z]|_)*:([a-z]|_)*$'</span><span class="p">)</span>
<span class="n">problemchars</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">r'[=</span><span class="err">\</span><span class="s">+/&amp;&lt;&gt;;</span><span class="se">\'</span><span class="s">"</span><span class="err">\</span><span class="s">?</span><span class="si">%#</span><span class="s">$@</span><span class="err">\</span><span class="s">,</span><span class="err">\</span><span class="s">. </span><span class="err">\</span><span class="s">t</span><span class="err">\</span><span class="s">r</span><span class="err">\</span><span class="s">n]'</span><span class="p">)</span>

<span class="c">#Utility data structures for nested dicts/lists</span>
<span class="n">TOP_LEVEL_DATA</span> <span class="o">=</span> <span class="p">[</span><span class="s">'id'</span><span class="p">,</span><span class="s">'visible'</span><span class="p">]</span>
<span class="n">CREATED</span> <span class="o">=</span> <span class="p">[</span> <span class="s">"version"</span><span class="p">,</span> <span class="s">"changeset"</span><span class="p">,</span> <span class="s">"timestamp"</span><span class="p">,</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"uid"</span><span class="p">]</span>
<span class="n">POS</span><span class="o">=</span><span class="p">[</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lon'</span><span class="p">]</span>

<span class="c">#This function returns a data dictionary by parsing the data from each key of an elements attributes</span>
<span class="c">#listed in the data_list argument</span>
<span class="k">def</span> <span class="nf">data_dict</span><span class="p">(</span><span class="n">elem_attribs</span><span class="p">,</span><span class="n">data_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">data_elem</span><span class="p">:</span><span class="n">elem_attribs</span><span class="p">[</span><span class="n">data_elem</span><span class="p">]</span> <span class="k">for</span> <span class="n">data_elem</span> <span class="ow">in</span> <span class="n">data_list</span> <span class="k">if</span> <span class="n">data_elem</span> <span class="ow">in</span> <span class="n">elem_attribs</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span> 

<span class="k">def</span> <span class="nf">extract_top_level_data</span><span class="p">(</span><span class="n">element</span><span class="p">):</span> <span class="c"># this function extract top level data from the elements attributes</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span><span class="n">TOP_LEVEL_DATA</span><span class="p">)</span>
    <span class="n">created_dict</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span><span class="n">CREATED</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">created_dict</span><span class="p">:</span>
        <span class="n">node</span><span class="p">[</span><span class="s">'created'</span><span class="p">]</span> <span class="o">=</span> <span class="n">created_dict</span>
    <span class="n">node</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span>
    <span class="k">return</span> <span class="n">node</span>
    
<span class="k">def</span> <span class="nf">shape_element</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
    <span class="n">node_refs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">"node"</span><span class="p">:</span> <span class="c">#Checks if is node and extracts required data</span>
       <span class="n">node</span> <span class="o">=</span> <span class="n">extract_top_level_data</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="nb">iter</span><span class="p">():</span>
            <span class="n">pos_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">pos_data</span><span class="p">])</span> <span class="k">for</span> <span class="n">pos_data</span> <span class="ow">in</span> <span class="n">POS</span> <span class="k">if</span> <span class="n">pos_data</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span> <span class="c">#extracts lat/lon data in list and converts to float</span>
            <span class="k">if</span> <span class="n">pos_list</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s">'pos'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_list</span>
       <span class="k">return</span> <span class="n">node</span>
    <span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">"way"</span><span class="p">:</span> <span class="c">#Checks if is way and extracts required data</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">extract_top_level_data</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="nb">iter</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span><span class="s">'tag'</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">problemchars</span><span class="p">,</span><span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">'k'</span><span class="p">])</span> <span class="c">#searches for problematic characters and returns None if encountered</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">'k'</span><span class="p">]</span> <span class="o">==</span><span class="s">"addr:street"</span><span class="p">:</span><span class="c">#Checks if way has addr:street attribute and assigns the 'street' key the streets name, otherwise 'highway'</span>
                    <span class="n">node</span><span class="p">[</span><span class="s">'street'</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">'v'</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">"highway"</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">and</span> <span class="s">'street'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">node</span><span class="p">[</span><span class="s">'street'</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">'k'</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">'nd'</span><span class="p">:</span>
                <span class="n">node_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">'ref'</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">node_refs</span><span class="p">:</span>
            <span class="n">node</span><span class="p">[</span><span class="s">"node_refs"</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_refs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">'street'</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s">'node_refs'</span><span class="p">])</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span> <span class="c">#Only return ways that have a addr:street or highway attribute and 2 or more node refs</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">process_map</span><span class="p">(</span><span class="n">file_in</span><span class="p">,</span> <span class="n">pretty</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="c"># You do not need to change this file</span>
    <span class="n">file_out</span> <span class="o">=</span> <span class="s">"{0}.json"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">file_out</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ET</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">file_in</span><span class="p">):</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">shape_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">el</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pretty</span><span class="p">:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="n">process_map</span><span class="p">(</span><span class="n">OSM_FILE</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"done"</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>done
</code></pre>
</div>

<h2>Data Analysis</h2>
<p>Now that the data has been cleaned and converted to json, it is able to be stored into a MongoDB database and queried for analysis. Although we’ll use the full dataset that was cleaned and stored in analyzing the “degree of diagonality” of Barcelona, thus not requiring custom MongoDB queries, an example of a query if we were interesting in only ways that are highways would be:<br />
query_results = db.barca_OSM.find({“street”:”highway”})</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Reference: Code from https://gist.github.com/jeromer/2005586</span>
<span class="k">def</span> <span class="nf">calculate_initial_compass_bearing</span><span class="p">(</span><span class="n">pointA</span><span class="p">,</span> <span class="n">pointB</span><span class="p">):</span>
    <span class="s">"""
    Calculates the bearing between two points.
    The formulae used is the following:
        θ = atan2(sin(Δlong).cos(lat2),
                  cos(lat1).sin(lat2) − sin(lat1).cos(lat2).cos(Δlong))
    :Parameters:
      - `pointA: The tuple representing the latitude/longitude for the
        first point. Latitude and longitude must be in decimal degrees
      - `pointB: The tuple representing the latitude/longitude for the
        second point. Latitude and longitude must be in decimal degrees
    :Returns:
      The bearing in degrees
    :Returns Type:
      float
    """</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pointA</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pointB</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">(</span><span class="s">"Only tuples are supported as arguments"</span><span class="p">)</span>

    <span class="n">lat1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">pointA</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lat2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">pointB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">diffLong</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">pointB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pointA</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">diffLong</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">diffLong</span><span class="p">))</span>

    <span class="n">initial_bearing</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c"># Now we have the initial bearing but math.atan2 return values</span>
    <span class="c"># from -180° to + 180° which is not what we want for a compass bearing</span>
    <span class="c"># The solution is to normalize the initial bearing as shown below</span>
    <span class="n">initial_bearing</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">initial_bearing</span><span class="p">)</span>
    <span class="n">compass_bearing</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_bearing</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>

    <span class="k">return</span> <span class="n">compass_bearing</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">degree_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"C:/Users/Cole/Desktop/Udacity/Data Analyst Nano Degree/Project 3/barcelona_spain.osm.json"</span><span class="p">,</span><span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
<span class="n">node_pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">datum</span><span class="p">[</span><span class="s">'id'</span><span class="p">]:</span><span class="n">datum</span><span class="p">[</span><span class="s">'pos'</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">datum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">datum</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span><span class="o">==</span><span class="s">'node'</span><span class="p">}</span>
<span class="k">for</span> <span class="n">indx</span><span class="p">,</span><span class="n">way_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">way_data</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'way'</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">node_1_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">node_pos</span><span class="p">[</span><span class="n">way_data</span><span class="p">[</span><span class="s">'node_refs'</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">node_2_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">node_pos</span><span class="p">[</span><span class="n">way_data</span><span class="p">[</span><span class="s">'node_refs'</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">degree_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate_initial_compass_bearing</span><span class="p">(</span><span class="n">node_1_pos</span><span class="p">,</span><span class="n">node_2_pos</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
<span class="k">print</span> <span class="n">degree_data</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>[267.85381820650105, 136.77552225283853, 225.17064639252413, 225.77167855473186, 169.69113420727763]
</code></pre>
</div>

<h2>Data Visualization</h2>
<p>With the street angle data, we can now generate a circular historgram plot across the street angles and visualize the most dominate directions of Barcelona streets.
Code adapted from <a href="http://stackoverflow.com/questions/22562364/circular-histogram-for-python">SO Circular Histogram for Python</a></p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">36</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">degree_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">bottom</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">radii</span> <span class="o">=</span> <span class="n">hist</span>
<span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">)</span>

<span class="c"># Use custom colors and opacity</span>
<span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">bar</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">))</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<p><img src="/img/output_12_0.png" alt="png" /></p>

<h2>Final Analysis</h2>
<p>It appears there are 3 dominate street angles at around 135o, 255o and 5o. Using this visualization as a guide, we could develop a measure of diagonality as defined by taking 1 minus the count of the 2 most dominate angle’s and dividing that by the total count of the dataset. A perfectly non-diagonal city would result in a diagonality measure of (1-Count(dominant_angles))/(total_angles) = 0 where the 2 dominant angles are the only angles = total angles</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">dominant_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">heapq</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">hist</span><span class="p">))</span>
<span class="n">total_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"barcelona degree of diagonality ="</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dominant_angles</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">total_angles</span><span class="p">)))</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>barcelona degree of diagonality =0.895038509762
</code></pre>
</div>

<h2>Final Conclusions</h2>
<p>The “degree of diagonality” of Barcelona using the above measure is 0.895. I intuitivley guess this is a relatively (globally speaking) high degree of diagonality, but other cities could be run through the above methodology and compared. I had alot of fun with the above analysis, and can think of many further areas to continue developing and errors to fix, but I have a Nano Degree to finish!</p>

  </section>
  
</article>

<!-- Post navigation -->


<!-- Disqus -->


    		</div> <!-- #et-main-area -->
		</div> <!-- #page-container -->
		
<script src="/js/katex_init.js"></script>



<footer id="page-footer-trans" class="page-footer">
	<!--<p class="text"><a href="http://cole-maclean.github.io/">Cole MacLean</a>
</p>-->
	<p class="text">Hosted by <a href="https://github.com">GitHub</a>. Theme created by <a href="https://github.com/fengzhichu/fengzhichu-theme/tree/gh-pages">枫之楚</a></p>
</footer>


    
<!-- WP Audio player plugin v1.9.3 - https://www.tipsandtricks-hq.com/wordpress-audio-music-player-plugin-4556/ -->
    <script type="text/javascript">
        soundManager.useFlashBlock = true; // optional - if used, required flashblock.css
        soundManager.url = '/plugins/soundmanager2.swf';
        function play_mp3(flg, ids, mp3url, volume, loops)
        {
            //Check the file URL parameter value
            var pieces = mp3url.split("|");
            if (pieces.length > 1) {//We have got an .ogg file too
                mp3file = pieces[0];
                oggfile = pieces[1];
                //set the file URL to be an array with the mp3 and ogg file
                mp3url = new Array(mp3file, oggfile);
            }

            soundManager.createSound({
                id: 'btnplay_' + ids,
                volume: volume,
                url: mp3url
            });

            if (flg == 'play') {
                    soundManager.play('btnplay_' + ids, {
                    onfinish: function() {
                        if (loops == 'true') {
                            loopSound('btnplay_' + ids);
                        }
                        else {
                            document.getElementById('btnplay_' + ids).style.display = 'inline';
                            document.getElementById('btnstop_' + ids).style.display = 'none';
                        }
                    }
                });
            }
            else if (flg == 'stop') {
    //soundManager.stop('btnplay_'+ids);
                soundManager.pause('btnplay_' + ids);
            }
        }
        function show_hide(flag, ids)
        {
            if (flag == 'play') {
                document.getElementById('btnplay_' + ids).style.display = 'none';
                document.getElementById('btnstop_' + ids).style.display = 'inline';
            }
            else if (flag == 'stop') {
                document.getElementById('btnplay_' + ids).style.display = 'inline';
                document.getElementById('btnstop_' + ids).style.display = 'none';
            }
        }
        function loopSound(soundID)
        {
            window.setTimeout(function() {
                soundManager.play(soundID, {onfinish: function() {
                        loopSound(soundID);
                    }});
            }, 1);
        }
        function stop_all_tracks()
        {
            soundManager.stopAll();
            var inputs = document.getElementsByTagName("input");
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].id.indexOf("btnplay_") == 0) {
                    inputs[i].style.display = 'inline';//Toggle the play button
                }
                if (inputs[i].id.indexOf("btnstop_") == 0) {
                    inputs[i].style.display = 'none';//Hide the stop button
                }
            }
        }
    </script>
    <script type='text/javascript' src="/js/frontend-builder-global-functions.js"></script>
<script type='text/javascript' src="/js/custom.js"></script>
<script type='text/javascript' src="/js/jquery.fitvids.js"></script>
<script type='text/javascript' src="/js/waypoints.min.js"></script>
<script type='text/javascript' src="/js/jquery.magnific-popup.js"></script>
<script type='text/javascript'>
/* <![CDATA[ */
var et_custom = {"ajaxurl":"http:\/\/blog.ibireme.com\/wp-admin\/admin-ajax.php","images_uri":"http:\/\/blog.ibireme.com\/wp-content\/themes\/Divi\/images","builder_images_uri":"http:\/\/blog.ibireme.com\/wp-content\/themes\/Divi\/includes\/builder\/images","et_load_nonce":"ae39988568","subscription_failed":"Please, check the fields below to make sure you entered the correct information.","fill":"Fill","field":"field","invalid":"Invalid email","captcha":"Captcha","prev":"Prev","previous":"\u4e0a\u4e00\u9875","next":"\u4e0b\u4e00\u9875","is_builder_plugin_used":""};
/* ]]> */
</script>
<script type='text/javascript' src="/js/frontend-builder-scripts.js"></script>
  </body>
</html>
